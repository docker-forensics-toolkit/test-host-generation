{
  "variables":
    {
    "iso_url": "https://stable.release.core-os.net/amd64-usr/current/coreos_production_iso_image.iso",
    "iso_checksum": "bf02f5fadcb9472f9710fd992067fe7947da2a9445c9243a0d7ca5f85e9b4f7815b0aa9d2f37b51171bd231aaac311267250a99118ed195078cff6f08f9373ab",
    "release": "stable"
    },
  "builders": [
    {
      "type": "virtualbox-iso",
      "guest_os_type": "Linux_64",
      "iso_url": "{{user `iso_url`}}",
      "iso_checksum": "{{user `iso_checksum`}}",
      "iso_checksum_type": "sha512",
      "disk_size": "6000",
      "memory": 2048,
      "ssh_username": "core",
        "http_directory": "files",
      "ssh_private_key_file": "id_rsa",
      "ssh_timeout" : "10m",
      "shutdown_command": "sudo poweroff --force --force --no-sync",
      "boot_command": [
        "curl -sLo /tmp/ignition.json http://{{ .HTTPIP }}:{{ .HTTPPort }}/ignition.json",
        "<enter>",
        "sudo coreos-install -d /dev/sda -C {{user `release`}} -i /tmp/ignition.json",
        "<enter>",
        "sudo reboot",
        "<enter>"
      ],
      "boot_wait": "15s"
    }
  ],
    "provisioners": [
        {
            "type": "shell",
            "inline": ["docker run -d --name \"apache\" --restart always httpd:2.4.38-alpine"]
        }
    ],
    "post-processors": [
	{
	  "type": "shell-local",
	  "inline": ["printenv", "for disk in output-virtualbox-iso/*.vmdk; do qemu-img convert -f vmdk \"$disk\" -O raw \"$disk\".raw; done"]
	}
    ]
}
